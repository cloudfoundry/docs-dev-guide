<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Rails 3, Running Worker Tasks</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_procedures docs_procedures_rails-running-worker-tasks">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='header'>
        <div class='container_wide'>
          <ul class='actions'>
            <li class='last'>
              <a href="http://www.cloudfoundry.com/contact">Contact Us</a>
            </li>
            <li>
              <a class='register_link' href='http://login.run.pivotal.io/login'>My Account</a>            
            </li>
          </ul>
        </div>
      </div>
      <div id='content'>
        <div class='logo-main'>
          <div class='logo'>
            <a href='http://www.cloudfoundry.com'>
            <img src='/images/logo-cloudfoundry.png'>
            </a>
            <a href='http://www.gopivotal.com' target="_blank">
            <img id="pivotal-logo" src='/images/logo-pivotal.png'>
            </a>
          </div>
          <div class='cta'>
            <a href='https://console.run.pivotal.io'>
            <img src='/images/signup_freetrial.png'>
            </a>
          </div>
        </div><!-- End of logo-main-->
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                <li>
                <a href='http://www.cloudfoundry.com/use' id='use'>Using Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/run' id='run'>Running Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/getinvolved' id='getinvolved'>Get Involved</a>
                </li>
                <li id='docs-off'>
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/">Deploy Applications</a></li> <li class=""><a href="/docs/procedures/">Application Deployment Procedures</a></li> <li class="active"><span>Rails 3, Running Worker Tasks</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"><ul>
<li><a href="#intro">Introduction</a></li>
<li><a href="#worker-libs">Choosing a worker task library</a></li>
<li><a href="#example-app">Creating an example application</a></li>
<li><a href="#test">Testing the application</a></li>
<li><a href="#test">Scale your workers</a></li>
</ul>
</div>

              <h1>Rails 3, Running Worker Tasks</h1>

            
            <h2><a id='intro'></a>Introduction</h2>

<p>Often when developing a Rails 3 application, you may want delay certain tasks so as not to consume resource that could be used for servicing requests from your user.</p>

<p>This quick guide will show you how to create and deploy an example Rails application that will make use of a worker library to defer a task, this task will then be executed by a separate application. The guide will also show you how you can scale the resource available to the worker application.</p>

<h2><a id='worker-libs'></a> Choosing a worker task library</h2>

<p>The first task, is to decide which worker task library to use. Here is a summary of the three main libraries available for Ruby / Rails;</p>

<h3><a href="https://github.com/collectiveidea/delayed_job">Delayed::Job</a></h3>

<p>&ldquo;A direct extraction from <a href="http://www.shopify.com/">Shopify</a> where the job table is responsible for a multitude of core tasks.&rdquo;</p>

<h3><a href="https://github.com/defunkt/resque">Resque</a></h3>

<p>&ldquo;A Redis-backed library for creating background jobs, placing those jobs on multiple queues, and processing them later.&rdquo;</p>

<h3><a href="https://github.com/mperham/sidekiq">Sidekiq</a></h3>

<p>&ldquo;Uses threads to handle many messages at the same time in the same process. It does not require Rails but will integrate tightly with Rails 3 to make background message processing dead simple.&rdquo; This library is also Redis-backed and is actually somewhat compatible with Resque messaging.</p>

<p>There are a lot more too, see <a href="https://www.ruby-toolbox.com/categories/Background_Jobs">https://www.ruby-toolbox.com/categories/Background_Jobs</a> for more!</p>

<h2><a id='example-app'></a> Creating an example application</h2>

<p>For the purposes of the example application, we will use Sidekiq, setup is pretty straight forward and it&#39;s a very performant solution.</p>

<p>First, create a Rails application with an arbitrary model called things;</p>

<pre class="terminal">
$ rails create rails-sidekiq
$ cd rails-sidekiq
$ rails g model Thing title:string description:string
</pre>

<p>Add sidekiq and uuidtools to the Gemfile, it&#39;s going to end up looking like this;</p>
<pre class="highlight ruby"><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

<span class="n">gem</span> <span class="s1">'rails'</span><span class="p">,</span> <span class="s1">'3.2.9'</span>
<span class="n">gem</span> <span class="s1">'mysql2'</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">'sass-rails'</span><span class="p">,</span>   <span class="s1">'~&gt; 3.2.3'</span>
  <span class="n">gem</span> <span class="s1">'coffee-rails'</span><span class="p">,</span> <span class="s1">'~&gt; 3.2.1'</span>
  <span class="n">gem</span> <span class="s1">'uglifier'</span><span class="p">,</span> <span class="s1">'&gt;= 1.0.3'</span>
<span class="k">end</span>

<span class="n">gem</span> <span class="s1">'jquery-rails'</span>
<span class="n">gem</span> <span class="s1">'sidekiq'</span>
<span class="n">gem</span> <span class="s1">'uuidtools'</span>
</pre>
<p>Install the bundle;</p>

<pre class="terminal">
$ bundle install
</pre>

<p>Create a worker (in app/workers) for sidekiq to carry out it&#39;s tasks;</p>

<pre class="terminal">
$ touch app/workers/thing_worker.rb
</pre>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">ThingWorker</span>

  <span class="kp">include</span> <span class="no">Sidekiq</span><span class="o">::</span><span class="no">Worker</span>

  <span class="k">def </span><span class="nf">perform</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>

    <span class="n">count</span><span class="nf">.times</span> <span class="k">do</span>

      <span class="n">thing_uuid</span> <span class="o">=</span> <span class="no">UUIDTools</span><span class="o">::</span><span class="no">UUID</span><span class="nf">.random_create.to_s</span>
      <span class="no">Thing</span><span class="nf">.create</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;New Thing (</span><span class="si">#{</span><span class="n">thing_uuid</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;This is the description for thing </span><span class="si">#{</span><span class="n">thing_uuid</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

  <span class="k">end</span>

<span class="k">end</span>
</pre>
<p>This worker will create n number of things, where n is the value passed to the worker.</p>

<p>Create a controller for &#39;things&#39;;</p>

<pre class="terminal">
$ rails g controller Thing
</pre>
<pre class="highlight ruby"><span class="k">class </span><span class="nc">ThingController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def </span><span class="nf">new</span>
    <span class="no">ThingWorker</span><span class="nf">.perform_async</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="s1">'/thing'</span>
  <span class="k">end</span>

  <span class="k">def </span><span class="nf">index</span>
    <span class="vi">@things</span> <span class="o">=</span> <span class="no">Thing</span><span class="nf">.all</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
<p>Add a view to inspect our collection of things;</p>

<pre class="terminal">
$ mkdir app/views/things
$ touch app/views/things/index.html.erb
</pre>
<pre class="highlight html"><span class="err">&lt;</span>%= @things.inspect %&gt;
</pre>
<h2><a id='deploy'></a>Deploying once, deploying twice&hellip;</h2>

<p>This application needs to be deployed twice for it to work, once as a Rails web application and once as a standalone Ruby application. The easiest way to do this is to keep separate CF manifests for each application type;</p>

<p>Web Manifest (save this as web-manifest.yml);</p>
<pre class="highlight yaml"><span class="nn">---</span>
<span class="s">applications</span><span class="p">:</span>
<span class="p">-</span> <span class="s">name</span><span class="p">:</span> <span class="s">sidekiq</span>
  <span class="s">memory</span><span class="p">:</span> <span class="s">256M</span>
  <span class="s">instances</span><span class="p">:</span> <span class="s">1</span>
  <span class="s">host</span><span class="p">:</span> <span class="s">sidekiq</span>
  <span class="s">domain</span><span class="p">:</span> <span class="s">${target-base}</span>
  <span class="s">path</span><span class="p">:</span> <span class="s">.</span>
  <span class="s">services</span><span class="p">:</span>
    <span class="s">sidekiq-mysql</span><span class="p">:</span>
      <span class="s">vendor</span><span class="p">:</span> <span class="s">mysql</span>
      <span class="s">version</span><span class="p">:</span> <span class="s2">&quot;</span><span class="s">5.1&quot;</span>
      <span class="s">tier</span><span class="p">:</span> <span class="s">free</span>
    <span class="s">sidekiq-redis</span><span class="p">:</span>
      <span class="s">vendor</span><span class="p">:</span> <span class="s">redis</span>
      <span class="s">version</span><span class="p">:</span> <span class="s2">&quot;</span><span class="s">2.6&quot;</span>
      <span class="s">tier</span><span class="p">:</span> <span class="s">free</span>
</pre>
<p>Worker Manifest (save this as worker-manifest.yml);</p>
<pre class="highlight yaml"><span class="nn">---</span>
<span class="s">applications</span><span class="p">:</span>
<span class="p">-</span> <span class="s">name</span><span class="p">:</span> <span class="s">sidekiq-worker</span>
  <span class="s">memory</span><span class="p">:</span> <span class="s">256M</span>
  <span class="s">instances</span><span class="p">:</span> <span class="s">1</span>
  <span class="s">path</span><span class="p">:</span> <span class="s">.</span>
  <span class="s">command</span><span class="p">:</span> <span class="s">bundle exec sidekiq</span>
  <span class="s">services</span><span class="p">:</span>
    <span class="s">sidekiq-redis</span><span class="p">:</span>
      <span class="s">vendor</span><span class="p">:</span> <span class="s">redis</span>
      <span class="s">version</span><span class="p">:</span> <span class="s2">&quot;</span><span class="s">2.6&quot;</span>
      <span class="s">tier</span><span class="p">:</span> <span class="s">free</span>
    <span class="s">sidekiq-mysql</span><span class="p">:</span>
      <span class="s">vendor</span><span class="p">:</span> <span class="s">mysql</span>
      <span class="s">version</span><span class="p">:</span> <span class="s2">&quot;</span><span class="s">5.1&quot;</span>
      <span class="s">tier</span><span class="p">:</span> <span class="s">free</span>
</pre>
<p>The url &#39;sidekiq.cloudfoundry.com&#39; will probably be taken, change it in web-manifest.yml first.
Push the application with both manifest files;</p>

<pre class="terminal">
$ cf push -m web-manifest.yml
$ cf push -m worker-manifest.yml
</pre>

<p>CF will likely ask for a URL for the worker application, select option 2 - &ldquo;none&rdquo;.</p>

<h2><a id='test'></a>Testing the application</h2>

<p>Test the application by visiting the new action on the thing controller at the assigned url, in this example, the URL would have been <a href="http://sidekiq.cloudfoundry.com/thing/new">http://sidekiq.cloudfoundry.com/thing/new</a></p>

<p>This will create a new sidekiq job which will be queued in Redis and then picked up by the worker application, the browser is then redirected to /thing which will show the collection of &#39;things&#39;. The likelihood is that the task will be completed by Sidekiq before the browser has even redirected!</p>

<h2><a id='test'></a>Scale your workers</h2>

<p>The nice thing about this approach is it makes scaling your Sidekiq workers trivial, pending available resource.</p>

<p>Change the number of workers to two;</p>

<pre class="terminal">
$ cf scale sidekiq-worker --instances 2
</pre>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
          <li>
          <a href='http://www.cloudfoundry.com/about'>About</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://blog.cloudfoundry.com/'>Blog</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/partners'>Partners</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://docs.cloudfoundry.com'>Docs</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/faq'>FAQ</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://status.cloudfoundry.com/'>Status</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/support'>Support</a>
          </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            GoPivotal, Inc. All rights reserved.
            <a href='http://www.cloudfoundry.com/terms'>Terms</a>
            <a href='http://www.gopivotal.com/privacy-policy' target='_blank'>Privacy</a>
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
